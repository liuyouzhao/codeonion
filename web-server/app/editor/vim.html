<!doctype html>

<title>CodeOnion</title>
<meta charset="utf-8"/>

<link rel="stylesheet" href="./lib/codemirror.css">
<link rel="stylesheet" href="./addon/dialog/dialog.css">
<script src="./lib/codemirror.js"></script>
<script src="./addon/dialog/dialog.js"></script>
<script src="./addon/search/searchcursor.js"></script>
<script src="./mode/clike/clike.js"></script>
<script src="./addon/edit/matchbrackets.js"></script>
<script src="./keymap/vim.js"></script>
<script src="./base64.js"></script>
<article>
<form><textarea id="code" name="code">
#include "syscalls.h"
/* getchar:  simple buffered version */
int getchar(void)
{


  static char buf[BUFSIZ];      

  static      char *bufp = buf;
  static int n = 0;
  if (n == 0) {  /* buffer is empty */
    n = read(0, buf, sizeof buf);
    bufp = buf;
  }
  return (--n >= 0) ? (unsigned char) *bufp++ : EOF;
}
</textarea></form>
<div style="font-size: 13px; width: 300px; height: 30px;">Key buffer: <span id="command-display"></span></div>

<script>
    var i = 0;
    var gLastLines = [];
 
    var gCursorLineNumberBefore = -1;
    
    var gWholeLinesNumber = 0;
    
    var zipkeyscontent = ["<div class=\"CodeMirror-gutter-wrapper\" style=\"left: -29px; width: 29px;\">",
                   "<div class=\"CodeMirror-linenumber CodeMirror-gutter-elt\" style=\"left: 0px; width: 20px;\">",
                   "</div>",
                   "<pre class=\"\">",
                   "<span style=\"padding-right: 0.1px;\">",
                   "<span class=\"cm-variable\">",
                   "<span class=\"cm-keyword\">",
                   "<span class=\"cm-operator\">",
                   "<span>",
                   "</span>",
                   "<pre>",
                   "</pre>"];
                   
    var zipkeysziped = ["<gt>",
                   "<ln>",
                   "</d>",
                   "<pc>",
                   "<ss>",
                   "<scv>",
                   "<sck>",
                   "<sco>",
                   "<s>",
                   "</s>",
                   "<p>",
                   "</p>"];
                   
    var zipkeyshashcode = [];
    
    function initHashCode() {
        for(var i = 0; i < zipkeyscontent.length; i ++) {
            zipkeyshashcode[i] = hashCode(zipkeyscontent[i]);
        }
    }
    
    function hashCode(str) {
        var hash = 0;
        if(str.length > 0) {
            for(var i = 0; i < str.length; i ++) {
                var ch = str.charCodeAt(i);
                hash = Math.round(hash * 31 + ch);
            }
        }
        return hash;
    }
    
    function initLines(lines, dest) {
        var codes_lines = lines.getElementsByClassName("CodeMirror-code");
        var divs = document.getElementByTagName("div");
        for(var i = 0; i < divs.length; i ++) {
            dest[i] = divs[i].innerHTML;
        }
    }

    function initLastLines(lines) {
        initLines(lines, gLastLines);
    }
    
    function updateLastLines(lineNum, lineContent) {
        gLastLines[lineNum] = lineContent;
    }

    function diffLines(line1, line2) {
        
    }
    
    function getWholeLineNumber() {
        var lines = document.getElementsByClassName("CodeMirror-code");
        var divs = lines[0].children;
        return divs.length;
    }
    
    function zipLine(line) {
        var retLine = line;
        //console.log("before zip length: ", line.length);
        for(var i = 0; i < zipkeyscontent.length; i ++) {
            retLine = retLine.replace(new RegExp(zipkeyscontent[i], 'g'), zipkeysziped[i]);
        }
        var retLinePlaint = retLine;
        //retLine = base64encode(retLine);
        //var baseone = base64encode(line);
        //console.log("After zip length: ", retLine.length);
        //console.log(Math.round(retLine.length/line.length * 100) + "%");
        //console.log(Math.round(retLinePlaint.length/line.length * 100) + "%");
        //console.log(Math.round(baseone.length/line.length * 100) + "%");
        return retLinePlaint;
    }

    CodeMirror.commands.save = function(){ alert("Saving"); };
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "text/x-csrc",
        keyMap: "vim",
        matchBrackets: true,
        showCursorWhenSelecting: true
    });
    var commandDisplay = document.getElementById('command-display');
    var editorDisplay = document.getElementById("code");
    var keys = '';
    CodeMirror.on(editor, 'vim-keypress', function(key) {
        keys = keys + key;
        commandDisplay.innerHTML = keys;
    });
    CodeMirror.on(editor, 'vim-command-done', function(e) {
        keys = '';
        commandDisplay.innerHTML = keys;
    });

    CodeMirror.on(editor, 'mousedown', function(e) {
        var curPos = editor.getCursor();
        console.log("cur mouse:", curPos);
        gCursorLineNumberBefore = editor.getCursor().line;
        gWholeLinesNumber = getWholeLineNumber();
    });
    
    CodeMirror.on(editor, 'keydown', function(key) {
        gCursorLineNumberBefore = editor.getCursor().line;
        gWholeLinesNumber = getWholeLineNumber();
    });
    
    function processChanges() {
        var curPos = editor.getCursor();
        var lines = document.getElementsByClassName("CodeMirror-code");
        var divs = lines[0].children;
        
        var appendDeleteChange = 0;
        
        console.log("==============================================", gCursorLineNumberBefore, curPos.line);
        
        appendDeleteChange = gWholeLinesNumber < divs.length ? 1 : (gWholeLinesNumber > divs.length ? -1 : 0);
        
        if(curPos.line - gCursorLineNumberBefore >= 0) {
            for (var n = gCursorLineNumberBefore; n <= curPos.line; n ++) {
                var line = divs[n].innerHTML;
                line = zipLine(line);
                console.log("[STEVEN]", line);
            }
        }
        else {
            for (var n = curPos.line; n <= gCursorLineNumberBefore; n ++) {
                var line = divs[n].innerHTML;
                line = zipLine(line);
                console.log("[STEVEN]", line);
            }
        }
    }

    window.onOnionUpdate = function() {
       processChanges();
    }
</script>

</article>
